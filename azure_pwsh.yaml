###
# pwsh version of azure.yaml
# Uses PowerShell syntax for the postprovision hook
# This file is intended for environments where PowerShell is the preferred shell
# Replace contents of the existing azure.yaml with this file to use PowerShell commands
###
name: ai-foundry
# metadata:
#   template: ai-foundry@0.0.1
infra:
  provider: bicep
  path: infra

hooks:
  postprovision:
    shell: pwsh
    run: |
      Write-Host "=============================================="
      Write-Host "POST-PROVISION HOOKS STARTED"
      Write-Host "=============================================="
      Write-Host "Timestamp: $(Get-Date)"
      Write-Host ""
      
      # Activate virtual environment if it exists
      if (Test-Path ".evalenv\Scripts\Activate.ps1") {. .evalenv\Scripts\Activate.ps1}

      Push-Location scripts
      
      Write-Host "----------------------------------------------"
      Write-Host "STEP 1: Uploading data to Azure AI Search"
      Write-Host "----------------------------------------------"
      Write-Host "Starting: $(Get-Date)"
      python 01_upload_data_to_search.py
      if ($LASTEXITCODE -eq 0) {
        Write-Host "âœ“ Step 1 completed successfully at $(Get-Date)"
      } else {
        Write-Host "âœ— Step 1 failed at $(Get-Date)"
        exit 1
      }
      Write-Host ""
      
      Write-Host "----------------------------------------------"
      Write-Host "STEP 2: Deploying Container Apps"
      Write-Host "----------------------------------------------"
      Write-Host "Starting: $(Get-Date)"
      .\02_deploy_container_apps.ps1
      if ($LASTEXITCODE -eq 0) {
        Write-Host "âœ“ Step 2 completed successfully at $(Get-Date)"
      } else {
        Write-Host "âœ— Step 2 failed at $(Get-Date)"
        exit 1
      }
      Write-Host ""
      
      Pop-Location

  postup:
    shell: pwsh
    interactive: true
    run: |
       Write-Host "=============================================="
       Write-Host "Deployment Complete"
       Write-Host "Finished at: $(Get-Date)"
       Write-Host "=============================================="
       Write-Host ""
       $APP_URL = az containerapp show --name "$env:AZURE_CONTAINER_APP_NAME" --resource-group "$env:AZURE_RESOURCE_GROUP" --query "properties.configuration.ingress.fqdn" -o tsv
       Write-Host "ðŸš€ Application URL: https://$APP_URL"
       Write-Host ""  
