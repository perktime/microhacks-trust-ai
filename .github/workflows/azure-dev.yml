name: Evaluate RAG Flow test CH3

on:
  workflow_dispatch:
  push:
    branches:
      - techconch3

permissions:
  id-token: write
  contents: read

jobs:
  evaluate_target_app:
    runs-on: ubuntu-latest
    env:
      AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME }}
      AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}

      # Your script uses this as the evaluator deployment name
      AZURE_CHAT_MODEL: ${{ vars.AZURE_CHAT_MODEL }}

      # (Optional) keep these if your repo uses them elsewhere
      AZURE_CHAT_MODEL_VERSION: ${{ vars.AZURE_CHAT_MODEL_VERSION }}
      AZURE_EMBEDDING_MODEL: ${{ vars.AZURE_EMBEDDING_MODEL }}

      # project specific
      #AZURE_CONTAINER_APP_URL: ${{ vars.AZURE_CONTAINER_APP_URL }}
      AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install azd
        uses: Azure/setup-azd@v2.2.0

      # This makes DefaultAzureCredential work reliably in GitHub Actions
      - name: Login to Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Set az account
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az account set --subscription ${{env.AZURE_SUBSCRIPTION_ID}}

      - name: azd auth login (Federated Credentials)
        run: |
          azd auth login `
            --client-id "$Env:AZURE_CLIENT_ID" `
            --federated-credential-provider "github" `
            --tenant-id "$Env:AZURE_TENANT_ID"
        shell: pwsh

      # ðŸ”‘ This is what creates .azure/<env>/.env so your script can load AZURE_CONTAINER_APP_URL, etc.
      - name: Refresh azd environment variables
        run: |
          azd env refresh -e $AZURE_ENV_NAME --no-prompt
        env:
          AZD_INITIAL_ENVIRONMENT_CONFIG: ${{ secrets.AZD_INITIAL_ENVIRONMENT_CONFIG }}

      - name: Export azd env vars to GitHub Actions environment
        shell: bash
        run: |
          set -e
          ENV_FILE=".azure/${AZURE_ENV_NAME}/.env"
          echo "Loading $ENV_FILE"
          test -f "$ENV_FILE"
          grep -v '^\s*#' "$ENV_FILE" | grep -E '^[A-Za-z_][A-Za-z0-9_]*=' >> "$GITHUB_ENV"

      - name: Install evaluation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      # Optional but recommended: fail fast if backend isn't reachable (avoids hanging on input()).
      - name: Check backend is reachable
        run: |
          python -c "import os; print('AZURE_CONTAINER_APP_URL=', os.getenv('AZURE_CONTAINER_APP_URL','<missing>'))"
          test -n "$AZURE_CONTAINER_APP_URL"
          curl -f -sS "$AZURE_CONTAINER_APP_URL/api/health" || curl -f -sS "$AZURE_CONTAINER_APP_URL"

      - name: Run evaluation against deployed app
        run: |
          # If the script hits input() it will otherwise hang CI.
          printf "y\n" | python scripts/04_run_evaltarget.py

      - name: Upload evaluation results
        if: ${{ success() }}
        uses: actions/upload-artifact@v5
        with:
          name: eval_results_target
          path: evals/results/quality/results_target.jsonl
